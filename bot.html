import asyncio
from aiogram import Bot, Dispatcher, types, executor

TOKEN = '8337898993:AAGlATM17_cUZxY_vLxYMJE2dO2pFdx_ngg'
bot = Bot(token=TOKEN)
dp = Dispatcher(bot)

waiting = []
pairs = {}
active_timers = {}

CHAT_DURATION = 300  # 5 –º–∏–Ω—É—Ç –≤ —Å–µ–∫—É–Ω–¥–∞—Ö


async def end_chat(user1, user2):
    # –†–∞–∑—Ä—ã–≤–∞–µ–º —á–∞—Ç –∏ —É–≤–µ–¥–æ–º–ª—è–µ–º
    pairs.pop(user1, None)
    pairs.pop(user2, None)
    active_timers.pop(user1, None)
    active_timers.pop(user2, None)
    try:
        await bot.send_message(user1, "‚è∞ –í—Ä–µ–º—è —á–∞—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å. –î–ª—è –Ω–æ–≤–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –Ω–∞–ø–∏—à–∏ /start")
    except:
        pass
    try:
        await bot.send_message(user2, "‚è∞ –í—Ä–µ–º—è —á–∞—Ç–∞ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å. –î–ª—è –Ω–æ–≤–æ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –Ω–∞–ø–∏—à–∏ /start")
    except:
        pass
    # –í—Å—Ç–∞–≤–ª—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ –≤ –æ—á–µ—Ä–µ–¥—å, –µ—Å–ª–∏ –µ—â—ë —Ö–æ—Ç—è—Ç —á–∞—Ç
    if user1 not in waiting:
        waiting.append(user1)
    if user2 not in waiting:
        waiting.append(user2)
    await try_match()


async def start_timer(user1, user2):
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä, —á—Ç–æ–±—ã —á–µ—Ä–µ–∑ 5 –º–∏–Ω—É—Ç —Ä–∞–∑–æ—Ä–≤–∞—Ç—å —á–∞—Ç
    await asyncio.sleep(CHAT_DURATION)
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∞—Ç –µ—â—ë –∞–∫—Ç–∏–≤–µ–Ω
    if pairs.get(user1) == user2 and pairs.get(user2) == user1:
        await end_chat(user1, user2)


async def try_match():
    while len(waiting) >= 2:
        user1 = waiting.pop(0)
        user2 = waiting.pop(0)
        pairs[user1] = user2
        pairs[user2] = user1

        await bot.send_message(user1, "ü§´ –ü–∞—Ä—Ç–Ω—ë—Ä –Ω–∞–π–¥–µ–Ω! –ß–∞—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã–π. –ü–∏—à–∏ —Å—é–¥–∞. –£ –≤–∞—Å –µ—Å—Ç—å 5 –º–∏–Ω—É—Ç.")
        await bot.send_message(user2, "ü§´ –ü–∞—Ä—Ç–Ω—ë—Ä –Ω–∞–π–¥–µ–Ω! –ß–∞—Ç –∞–Ω–æ–Ω–∏–º–Ω—ã–π. –ü–∏—à–∏ —Å—é–¥–∞. –£ –≤–∞—Å –µ—Å—Ç—å 5 –º–∏–Ω—É—Ç.")

        # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞—Ç–∞
        task = asyncio.create_task(start_timer(user1, user2))
        active_timers[user1] = task
        active_timers[user2] = task


@dp.message_handler(commands=['start'])
async def start_handler(message: types.Message):
    user_id = message.from_user.id
    if user_id in pairs:
        await message.answer("–¢—ã —É–∂–µ –≤ —á–∞—Ç–µ. –ü–∏—à–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É –∏–ª–∏ –æ—Å—Ç–∞–Ω–æ–≤–∏ —á–∞—Ç –∫–æ–º–∞–Ω–¥–æ–π /stop")
        return
    if user_id in waiting:
        await message.answer("–¢—ã —É–∂–µ –≤ –æ—á–µ—Ä–µ–¥–∏, –∂–¥–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.")
        return

    waiting.append(user_id)
    await message.answer("–¢—ã –≤ –æ—á–µ—Ä–µ–¥–∏, –∂–¥–∏ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞.")
    await try_match()


@dp.message_handler(commands=['stop'])
async def stop_handler(message: types.Message):
    user_id = message.from_user.id
    if user_id in pairs:
        partner_id = pairs.pop(user_id)
        pairs.pop(partner_id, None)

        # –û—Ç–º–µ–Ω—è–µ–º —Ç–∞–π–º–µ—Ä
        task = active_timers.pop(user_id, None)
        if task:
            task.cancel()
        active_timers.pop(partner_id, None)

        await bot.send_message(user_id, "–ß–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π ‚Äî /start")
        await bot.send_message(partner_id, "–ß–∞—Ç –∑–∞–≤–µ—Ä—à—ë–Ω —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º. –ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –Ω–æ–≤—ã–π ‚Äî /start")

        # –ü–∞—Ä—Ç–Ω—ë—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
        if partner_id not in waiting:
            waiting.append(partner_id)
            await try_match()
    else:
        if user_id in waiting:
            waiting.remove(user_id)
            await message.answer("–¢—ã –≤—ã—à–µ–ª –∏–∑ –æ—á–µ—Ä–µ–¥–∏.")
        else:
            await message.answer("–¢—ã –Ω–µ –≤ —á–∞—Ç–µ –∏ –Ω–µ –≤ –æ—á–µ—Ä–µ–¥–∏.")


@dp.message_handler()
async def relay_message(message: types.Message):
    user_id = message.from_user.id
    if user_id in pairs:
        partner_id = pairs[user_id]
        text = message.text
        if not text:
            # –ò–≥–Ω–æ—Ä–∏–º –Ω–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (–º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –ø–æ–∑–∂–µ)
            return
        try:
            await bot.send_message(partner_id, f"üë§ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫: {text}")
        except:
            # –ï—Å–ª–∏ –Ω–µ —Å–º–æ–≥–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å (–ø–∞—Ä—Ç–Ω—ë—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ –∏ —Ç–ø) ‚Äî –∑–∞–≤–µ—Ä—à–∞–µ–º —á–∞—Ç
            await end_chat(user_id, partner_id)
    else:
        await message.answer("–¢—ã –Ω–µ –≤ —á–∞—Ç–µ. –ù–∞—á–Ω–∏ –Ω–æ–≤—ã–π /start")


if __name__ == '__main__':
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω. –ù–∞–∂–º–∏ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
    executor.start_polling(dp)
